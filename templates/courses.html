{% extends 'base.html' %}

{% block title %}Choose Your Course - AdaptLearn{% endblock %}

{% block content %}
<div class="courses-container">
    <div class="courses-header">
        <h2>What Do You Want to Learn?</h2>
        <p>Type any course or topic you want to master</p>
    </div>
    
    <div class="custom-course-section">
        <div class="custom-course-card">
            <h3>‚ú® Create Custom Course</h3>
            <p>Enter any course or topic you'd like to learn about</p>
            
            <div class="custom-input-group">
                <input 
                    type="text" 
                    id="customCourse" 
                    placeholder="e.g., Web Development, AI, Data Science, Python, React, etc..."
                    class="custom-course-input"
                    autocomplete="off"
                >
                <button class="btn btn-primary" onclick="startCustomCourse()">Start Learning</button>
            </div>
            
            <div id="suggestions" class="suggestions-list">
                <p class="suggestions-title">Popular Topics:</p>
                <div class="suggestion-tags">
                    <span class="suggestion-tag" onclick="setCustomCourse('Web Development')">Web Development</span>
                    <span class="suggestion-tag" onclick="setCustomCourse('Machine Learning')">Machine Learning</span>
                    <span class="suggestion-tag" onclick="setCustomCourse('Data Science')">Data Science</span>
                    <span class="suggestion-tag" onclick="setCustomCourse('React')">React</span>
                    <span class="suggestion-tag" onclick="setCustomCourse('Django')">Django</span>
                    <span class="suggestion-tag" onclick="setCustomCourse('Python')">Python</span>
                    <span class="suggestion-tag" onclick="setCustomCourse('JavaScript')">JavaScript</span>
                    <span class="suggestion-tag" onclick="setCustomCourse('SQL')">SQL</span>
                    <span class="suggestion-tag" onclick="setCustomCourse('Artificial Intelligence')">Artificial Intelligence</span>
                    <span class="suggestion-tag" onclick="setCustomCourse('Cloud Computing')">Cloud Computing</span>
                </div>
            </div>
            
            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </div>
    </div>
</div>

<div id="transitionOverlay" class="transition-overlay" style="display: none;">
    <div class="transition-content">
        <div class="spinner"></div>
        <p id="transitionMessage">üöÄ Generating your personalized assessment with dynamic questions...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Check authentication
if (!localStorage.getItem('token')) {
    window.location.href = '/login/';
}

function setCustomCourse(courseName) {
    document.getElementById('customCourse').value = courseName;
    document.getElementById('customCourse').focus();
}

async function startCustomCourse() {
    const courseName = document.getElementById('customCourse').value.trim();
    const errorDiv = document.getElementById('errorMessage');
    
    // Validate input
    if (!courseName || courseName.length < 2) {
        errorDiv.textContent = '‚ùå Please enter a valid course/topic name (at least 2 characters)';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (courseName.length > 100) {
        errorDiv.textContent = '‚ùå Course name too long (max 100 characters)';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Hide error and show loading
    errorDiv.style.display = 'none';
    const overlay = document.getElementById('transitionOverlay');
    overlay.style.display = 'flex';
    
    try {
        console.log('Starting assessment for:', courseName);
        
        const response = await fetch('/api/assessment/start-custom/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Token ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({ 
                course_name: courseName
            })
        });
        
        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);
        
        if (!response.ok) {
            throw new Error(data.error || 'Failed to start assessment');
        }
        
        if (!data.quiz || !data.quiz.questions) {
            throw new Error('No quiz data in response');
        }
        
        // Store data
        console.log('Storing quiz data...');
        sessionStorage.setItem('quiz_data', JSON.stringify(data.quiz));
        sessionStorage.setItem('assessment_id', data.quiz.assessment_id);
        
        console.log('Quiz data stored, redirecting...');
        
        // Redirect to assessment page
        setTimeout(() => {
            window.location.href = '/assessment/';
        }, 1000);
        
    } catch (error) {
        console.error('Error caught:', error);
        overlay.style.display = 'none';
        errorDiv.textContent = `‚ùå ${error.message}`;
        errorDiv.style.display = 'block';
    }
}

// Allow Enter key to start
document.getElementById('customCourse').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        startCustomCourse();
    }
});
</script>
{% endblock %}
